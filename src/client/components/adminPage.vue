<template>
	<div class="admin-scope">
		<p>Minazuki admin page</p>

		<h2>{%LicenseManagement%}</h2>
		<button @click="createLicense()">{%Create%}</button>

		<button @click="listLicenses()">{%Reload%}</button>
		<ul>
			<li v-for="license in licenses" :key="license.key">
				<p>key: {{ license.key }}</p>
				<p>enabled: {{ license.enabled }}</p>
				<p>activated: {{ license.activated }}</p>
				<button v-if="license.enabled" @click="disableLicense(license)">{%Disable%}</button>
				<button v-else @click="enableLicense(license)">{%Enable%}</button>
				<button @click="deleteLicense(license)">{%Delete%}</button>
			</li>
		</ul>
	</div>
</template>

<script>
import callApi from '../modules/callApi';

function callAdminApi(vueInstance, path, params = {}) {
	params.token = vueInstance.$root.$data.token;
	return callApi(path, params);
}

export default {
	data() {
		return {
			licenses: []
		};
	},
	methods: {
		async createLicense() {
			try {
				const res = await callAdminApi(this, '/admin/license/create');
				if (!res.success) {
					alert('api error:', res.error.message);
					return;
				}
				this.licenses.push(res.content.license);
			}
			catch (err) {
				alert(`request error: ${err.message || err}`);
			}
		},
		async listLicenses() {
			try {
				const res = await callAdminApi(this, '/admin/license/list');
				if (!res.success) {
					alert('api error:', res.error.message);
					return;
				}
				this.licenses = res.content.licenses;
			}
			catch (err) {
				alert(`request error: ${err.message || err}`);
			}
		},
		async deleteLicense(license) {
			try {
				const res = await callAdminApi(this, '/admin/license/delete', {
					key: license.key
				});
				if (!res.success) {
					alert('api error:', res.error.message);
					return;
				}
				// remove the item from the license list
				const licenseIndex = this.licenses.findIndex(it => it.key == license.key);
				this.licenses.splice(licenseIndex, 1);
			}
			catch (err) {
				alert(`request error: ${err.message || err}`);
			}
		},
		async enableLicense(license) {
			try {
				const res = await callAdminApi(this, '/admin/license/enable', {
					key: license.key
				});
				if (!res.success) {
					alert('api error:', res.error.message);
					return;
				}
				license.enabled = true;
			}
			catch (err) {
				alert(`request error: ${err.message || err}`);
			}
		},
		async disableLicense(license) {
			try {
				const res = await callAdminApi(this, '/admin/license/disable', {
					key: license.key
				});
				if (!res.success) {
					alert('api error:', res.error.message);
					return;
				}
				license.enabled = false;
			}
			catch (err) {
				alert(`request error: ${err.message || err}`);
			}
		}
	},
	created() {
		this.listLicenses();
	}
};
</script>

<style lang="scss" scoped>
.admin-scope {
	margin: 1rem;

	ul {
		padding: 0;

		li {
			list-style: none;
			border: 1px solid rgb(155, 155, 155);
			padding: 1rem;
			margin: 1rem 0;

			p {
				margin: 0;
			}
		}
	}
}
</style>
